# SPDX-FileCopyrightText: 2019 Bitcoin Suisse
# SPDX-License-Identifier: LicenseRef-Proprietary

env:
  NIX_PATH: nixpkgs=channel:nixos-unstable
  test_step: "test && weeder && bats"

steps:
 - command: nix run nixpkgs.{gnumake,hlint,ncurses} -c make lint
   label: make lint
 - command: nix run nixpkgs.reuse -c reuse lint
   label: reuse lint
 - command: .buildkite/check-trailing-whitespace.sh
 - command: "nix run -f https://github.com/serokell/crossref-verifier/archive/master.tar.gz -c crossref-verify"
   label: crossref-verify
   soft_fail: true
 - commands:
   - nix-shell --run "make test-ci"
   - echo +++ Weeder
   - nix-shell --run "nix run nixpkgs.haskellPackages.weeder -c weeder ."
   - echo +++ Bats
   - nix-shell --run "nix run nixpkgs.bats -c bats test.bats"
   - echo 'bats passed successfully'
   - echo +++ Smoke
   - nix-shell --run "nix run nixpkgs.python3 -c bash scripts/ci-test.sh"
   - echo 'ci-test passed successfully'
   - nix-shell --run "stack exec tzbtc printContractDoc > TZBTC-contract.md"
   label: ${test_step}
   artifact_paths:
     - "TZBTC-contract.md"

 - commands:
   - nix-shell --run "mkdir tmp"
   - nix-shell --run "buildkite-agent artifact download TZBTC-contract.md tmp/ --step \"${test_step}\""
   - nix-shell --run "cd tmp"
   - nix-shell --run "nix run -f https://github.com/serokell/crossref-verifier/archive/master.tar.gz -c crossref-verify"
   label: crossref-verify generated doc

   branches: !autodoc/*

 - commands:
   - nix-shell --run "buildkite-agent artifact download TZBTC-contract.md . --step \"${test_step}\""
   - ./scripts/ci/upload-autodoc.sh
   label: autodoc upload
   branches: "master"
